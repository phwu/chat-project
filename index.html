<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      #messages, #names { list-style-type: none; margin: 0; padding: 0; }
      #messages li, #names li { padding: 5px 10px; }
      #messages li:nth-child(odd), #names li:nth-child(odd) { background: #eee; }
    </style>
  </head>
  <body class="container-fluid">
  <div class="row">
    <form id="login" class="col-md-5">
      <div class="form-group">
        <label>Name</label>
        <input id="name" type="text"/>
        <button type="submit" class="btn btn-default">Login</button>
      </div>
    </form>
    <div class="col-md-2"></div>
    <ul id="options" class="col-md-8 nav nav-pills">
      <li class="disabled"><a href="#" onClick="createRoom()">Create Room</a></li>
      <li>Join Room <span class="badge" id="room-count">0</span> :</li>
    </ul>
  </div>
  <div class="row">
    <ul class="col-md-2" id="names"></ul>
    <ul class="col-md-10" id="messages"></ul>
  </div>
    <form id="chat">
      <div class="form-group">
        <label>Message</label>
        <input id="m" type="text" />
        <button type="submit" class="btn btn-default" disabled="disabled">Submit</button>
      </div>
    </form>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      // create a socket
      var socket = io();

      // some handy dandy variables
      var name = '';
      var mg = '';
      var room = '';

      // get user name 
      // TODO authentication
      $('#login').submit(function() {
        name = $('#name').val();
        $('#login input').prop('disabled', true);
        $('#login button').prop('disabled', true);
        $('#options li').removeClass("disabled");
        socket.emit('get rooms', {});
        return false;
      })

      // create a room based on username, client assumes if you create a room, you're going to join it
      function createRoom() {
        socket.emit('create room', name);
        room = name;
        $('#options li').addClass('disabled');
        $('#chat button').prop('disabled', false);
      };

      // show available rooms.... this could be helpful for operators
      socket.on('rooms list', function(rooms) {
        $('#options').find('#room-count').text(rooms.length);
        
        rooms.forEach(function(room) {
          // nasty ....
          html = '<a href="#" onClick="joinRoom('+"'"+room+"'"+')">'+room+'</a>';
          $('#options').append($('<li>').append(html));
        });
      });

      // now we can join rooms
      function joinRoom(rm) { 
        // basically same as creating a room, cept we pass a room name rather than using the user's name
        socket.emit('create room', rm);
        room = rm;
        $('#options li').addClass('disabled');
        $('#chat button').prop('disabled', false);
      };
      
      // we always want to send the message to clients in the same room
      $('#chat').submit(function() {
        mg = $('#m').val();
        var date = new Date();
        var data = {
          name: name,
          mg: mg,
          room: room,
          date: date
        };
        // this will ensure only sockets connected in the same room get the message
        socket.emit('message to room', data);
        // go ahead and propagate message to screen since it's from your client anyways!
        $('#names').append($('<li>').text(data.name));
        $('#messages').append($('<li>').text(data.mg));
        // reset the message boxx
        $('#m').val('');
        return false;
      });

      socket.on('convo', function(data) {
        // we got our packet from the other client(s) in the room, let's propagate that data!
        $('#names').append($('<li>').text(data.name));
        $('#messages').append($('<li>').text(data.mg));
      });

      // messages pushed from the server, can be used to send alerts from server side ...
      socket.on('system msg', function(msg) {
        $('#names').append($('<li class="text-uppercase">').text('*****'));
        $('#messages').append($('<li>').text(msg));
      });
            
    </script>
  </body>
</html>